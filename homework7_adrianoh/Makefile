TARGETS := mdriver

CC := clang
CFLAGS := -std=gnu99 -g -Wall -Werror -Wextra -Wno-write-strings -Wno-unused-parameter -march=x86-64
LDFLAGS := -lm

HEADERS := \
	allocator_interface.h \
	config.h \
	fsecs.h \
	mdriver.h \
	memlib.h \
	validator.h

# Blank line ends list.

# If you add a new file called "filename.c", you should
# add "filename.o \" to this list.
OBJS := \
	memlib.o

MDRIVER_OBJS:= \
	simple_allocator.o \
	wrapped_allocator.o \
	packed_allocator.o \
	fixed_aligned_allocator.o \
	smart_allocator.o \
	clock.o \
	fcyc.o \
	fsecs.o \
	ftimer.o \
	libc_allocator.o \
	mdriver.o


# Blank line ends list.

ifeq ($(DEBUG),1)
	CFLAGS := -DDEBUG -O0 $(CFLAGS)

else
	CFLAGS := -DNDEBUG -O3 $(CFLAGS)

endif

# make all targets specified
all: $(TARGETS)

mdriver: $(OBJS) $(MDRIVER_OBJS)
	$(CC) $(PARAMS) $(LDFLAGS) $(OBJS) $(MDRIVER_OBJS) -o $@

# compile objects

# pattern rule for building objects
%.o: %.c
	$(CC) $(PARAMS) $(CFLAGS) -c $< -o $@


# run each of the targets
.PHONY: run
run: $(TARGETS)
	for X in $(TARGETS) ; do \
		echo $$X -v ; \
		./$$X -v ; \
		echo ; \
	done

.PHONY: runall
runall: $(TARGETS)
	for X in $(TARGETS) ; do \
		./$$X -v -W; \
		./$$X -v -A; \
		./$$X -v -F; \
		./$$X -v -S; \
		echo ; \
	done

.PHONY: partial_clean
partial_clean:
	$(RM) -R $(TARGETS) $(OBJS) $(MDRIVER_OBJS) *.std*
	$(RM) -R tmp/*.out

.PHONY: autotune
autotune:
	./opentuner_run.py --test-limit=300 --no-dups --display-frequency=20 --trace-file=${TRACE_FILE}

# remove targets and .o files as well as output generated by CQ
.PHONY: clean
clean: partial_clean
	$(RM) -R *.db* *.log
